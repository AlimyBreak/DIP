# <center>形态学图像处理</center>

***

| 文件版本 |     修改日期/作者     |                   备注内容                    |
| :------: | :-------------------: | :-------------------------------------------: |
|   V0.1   | 2019.10.31/AlimyBreak | 首次编写该文档,卡在__区域填充__的连通分析理论 |



***

Ref:

1. <<精通Matlab数字图像处理与识别>> 张铮等编著 2013.04.01第一版 Page220

***



## 一.  预备知识

+ 数学形态学，主要应用是从图像中__提取__对于表达和描绘区域形状__有意义__的图像分量，使后续的识别工作能够抓住目标对象最本质(最具区分能力-most discriminative)的形状特征，如__边界__和__连通区域__；同时__像细化__、__像素化__和__修剪毛刺__等技术也常常应用于图像的预处理和后处理中，成为图像增强技术的有力补充.
+ 形态学是借助__集合论__的语言来描述.
  + __结构元素__(structure element):设有两副图像$A$和$S$,若$A$是被处理的对象，而$S$是用来处理$A$的，则称$S$为结构元素。结构元素通常都是一些比较小的图像，$A$与$S$的关系类似滤波中__图像__和__模板__的关系.





## 二.  二值图像中的基本形态学运算

+ __前景认定习惯__：默认情况下白色的(二值图像中的灰度值为1的像素，或灰度图像中灰度值为255的像素)是前景(物体)，黑色的为背景.

### 2.1  腐蚀操作

+ 理论基础
  
  + 对于$Z^2$上的元素集合$A$和$S$,使用$S$对$A$进行腐蚀操作，记做$A\ominus S$,形式化地定义
    $$
    A\ominus S =\{z\mid(S)_z\subseteq A\}
    $$
  
  + 让原本位于图像原点的结构元素$S$在整个$Z^2$平面上移动,如果当$S$的原点平移至$z$点时能完全包含在$A$中,则所有这样$z$点构成的集合即为$S$对$A$的腐蚀图像.
  
  + 可以通过设置$S$的属性来筛选出满足条件的所有$z$点，一般来说所有$z$点构成的集合元素会二值图像中的物体轮廓的图像元素构成的集合元素少一些.
  
+ matlab 函数及用例

  + $erode.m$
  + 效果：

  ![erode](%E6%95%B0%E5%AD%97%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86_%E5%BD%A2%E6%80%81%E5%AD%A6%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0.assets/erode.bmp)

+ halcon 函数及用例(略)

+ opencv函数及用例(略)

+ 腐蚀的作用:

  + 腐蚀能消融物体的边界，腐蚀结果与图像本身和结构元素有关
    + 若物体整体上大于结构元素，腐蚀的结果是使得物体"瘦"一圈，这一圈到底是多大由结构元素决定；
    + 若物理本身小于结构元素，则在腐蚀后图像中的物体将完全消失；
    + 若物体仅有部分区域小于结构元素（在细小的连通），则腐蚀后物体会在细小的连通处__断裂__，分离为两部分.



### 2.2  膨胀操作

+ 理论基础

  + 对$Z^2$上元素的集合$A$和$S$,使用$S$对$A$进行膨胀,记作$A\oplus S$,形式化地定义为
    $$
    A\oplus S =\{(\hat{S})_z\cap A\ne\varnothing\}
    $$

  + 设想有原本位于图像原点的结构元素$S$,让$S$在整个$Z^2$平面上移动，当其自身原点平移至$z$点时，$S$相对于其自身的原点的映像$\hat{S}$和$A$有公共交集，即$\hat{S}$和$A$至少有一个像素是重叠的，则所有这样的$z$点构成的集合为$S$对$A$的膨胀图像.

  + 实际上膨胀和腐蚀对于集合求补和反射运算是彼此对偶的，与前景认定习惯相反的图片进行膨胀对应的就是与前景认定习惯相同的图片进行腐蚀一样操作，区别是像素需要取反.

+ MATLAB函数及用例

  + $delilate.m$

  + 效果：

    ![delilate](%E6%95%B0%E5%AD%97%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86_%E5%BD%A2%E6%80%81%E5%AD%A6%E7%9B%B8%E5%85%B3%E7%AC%94%E8%AE%B0.assets/delilate.bmp)

+ Halcon函数及用例(略)

+ opencv函数及用例(略)

+ 膨胀的作用:

  + 和反射相反，__膨胀能使物体边界扩大__；具体的膨胀结果与图像本身和结构元素的形状有关，膨胀常用于将图像中原本断裂开来的同一物体桥接起来。
  + 对图像进行二值化之后，很容易使得一个连接的物体断裂为两个部分，而这会给后续的图像分析造成困扰（如要基于连通区域的分析统计物体的个数），此时就可借助膨胀桥接断裂的缝隙.





### 2.3  开运算

+ 开运算和闭运算都是由腐蚀和膨胀复合而成的，__开运算是先腐蚀后膨胀__，而__闭运算是先膨胀后腐蚀__。

+ 理论基础:

  + 使用结构元素$S$对$A$进行开运算，记作$A\circ S$，可表示为
    $$
    A\circ S = (A\ominus S)\oplus S
    $$

  + 一般来说，开运算使图像的轮廓变得光滑，断开狭窄的连接和消除毛刺。

  + 查看imopen中的MATLAB源代码可以发现，就是先腐蚀后膨胀

  ```matlab
  outputImage = imdilate(imerode(inputImage,se,packopt,M),se,packopt,M);
  ```

  

### 2.4  闭运算

+ 开运算和闭运算都是由腐蚀和膨胀复合而成的，__开运算是先腐蚀后膨胀__，而__闭运算是先膨胀后腐蚀__。

+ 理论基础:

  + 使用结构元素$S$对$A$进行闭运算，记作$A\bullet S$,可表示为
  $$
  A\bullet S = (A\oplus S)\ominus S
  $$

  + 查看imclose的MATLAB源代码可以发现，就是先膨胀后腐蚀

  ```matlab
  outputImage = imerode(imdilate(inputImage,se,packopt,M),se,packopt,M);
  ```
  
+ 开闭运算也是对偶的，但是对于某图像应用多次开或闭运算和只进行一次运算的效果相同,即
  $$
  (A\circ B)\circ B =A\circ B,(A\bullet B)\bullet B=A\bullet B
  $$
  





## 三.  二值图像中形态学应用

+ 一些经典的形态学应用，都是基本运算(腐蚀、膨胀、开运算和闭运算)的特定次序组合，并采用一些特殊的结构元素来实现的。
  + 击中与击不中变换
  + 边界提取与跟踪
  + 区域填充
  + 连通分量提取及其实现
  + 细化算法
  + 像素化算法





### 3.1  击中与击不中变换及其实现

+ 击中与击不中变换是一种__形状检测的基本工具__，常用于图像中特定形状的精准定位。

+ [理论基础](https://blog.csdn.net/u013263891/article/details/83690309):
  
  + 记作
  
    $$
    A\otimes S = (A\ominus S_1)\cap(A^c\ominus S_2)
    $$
  
  + 其中$S_1\cap S_2=\varnothing$且$S=S_1\cup S_2$
  
  + 实际上$S_1$代表我们感兴趣的物体(要检测的形状)对应的集合，而$S_2$为$S$中背景部分对应的集合.
  
  + 首先用我们感兴趣的物体$S_1$去腐蚀图像$A$,得到的结果是使$S_1$完全包含于$A$中前景部分时中心点位置的集合$U_1$,__可以将$U_1$看做$S_1$在$A$中所有匹配点的集合__.
  
  + 为了在$A$中精确地定位$S_1$而排除掉那些仅仅包含$S_1$但不同于$S_1$的物体或区域，有必要引入和$S_1$相关的背景部分$S_2$,一般来说$S_2$是$S_1$周围包络着$S_1$的背景部分，$S_1$和$S_2$并在一起组成了$S$.
  
  + $A^c\ominus S_2$正是计算图像$A$的背景$A^c$与$S$的背景部分$S_2$的腐蚀，得到的结果$U_2$是使$S$的背景部分$S_2$完全包含于$A^c$时$S$中心位置的集合.
  
  + $U_1$和$U_2$的交集是这样一些$p$点的集合：当$S$中心位于$p$时，$S$的前景(物体)部分$S_1$和$A$中的某个前景完全重合，而$S$的背景部分也这$A$的某个背景部分完全重合，而$S_1$又是包络在$S_2$其中的，从而保证了我们感兴趣物体$S_1$在图像$A$的p点处找到了一个精准匹配.
  
+ Matlab实现及例子

  + $bwhitmiss\_my.m$
  + $bwhitmiss\_matlab.m$

+ 对于结构元素$S$,我们感兴趣的物体$S_1$之外的$S_2$不能选得太宽，因为使得$S$包含背景$S_1$的外轮廓，以便在图像中能够找到准确的完全匹配位置。从这个意义而言，物体$S_1$周围有一个像素款的背景环绕就足够了，$S_2$选择的太大，可能导致计算出来的结果为空集.

+ 根据$(A\ominus B)^c=A^c\oplus \hat{B}$和$\tag{6}$,可以得到(书上的公式写错了)
  $$
  \begin{eqnarray}
  A\otimes S &=&(A\ominus S_1)\cap(A^c\ominus S_2)\\
  &=&(A\ominus S_1)\cap(A\oplus\hat{S}_2)^c \\
  &=&(A\ominus S_1)-(A\oplus\hat{S}_2)
  \end{eqnarray}
  $$
  





### 3.2  边界提取与跟踪及其实现

+ 轮廓是对物体形状的有力描述，对于图像分析和识别。通过__边界提取算法__可以得到物体的边界轮廓；而__边界跟踪算法__在提取边界的同事还能依次记录下__边界像素的位置信息__.

#### 3.2.1  边界提取

+ 要在二值图像中提取物体的边界，容易想到的一个方法是将所有物体内部的点删除(置为背景色)。
+ 可以逐行扫描原图像，若发现一个前景点的8个邻域点都是前景点，则该点为内部点，在目标图像中将它删除。
+ 实际上就是相当于采用一个$3\times3$的结构元素对原图像进行腐蚀，使得只有那些8个点邻域都是前景点的内部点被保留，再用原图像减去腐蚀后图像，恰好删除了这些内部点，留下了边界像素.
+ matlab程序和实例
  + $getEdge.m$

#### 3.2.2  边界跟踪

+ 为了__依次记录边界上下的各个像素__，边界跟踪：首先按照某种扫描规则找到目标物体边界上的一个像素，而后以这该像素点为起始点，根据某种顺序(如顺时针或逆时针)依次找出物体边界上的其他元素，直到又回到起始点，完成整条边界的跟踪.
+ 我们可以按照从左到右、从上到下的顺序扫描图像，这样会首先找到目标物体最左上方的边界点$P_0$,可以采用逆时针的方法对周围可能的8个点进行搜索.





### 3.2  区域填充

+ 区域填充可以看做__边界提取的反过程__，它是在__边界已知__的情况下得到边界包围的整个区域的形态学技术.
+ [连通域概念](https://www.jianshu.com/p/2aef925ed39e)：
  + 两个像素连通的两个条件是：
    + 两个像素的位置是否相邻
    + 两个像素的灰度值是否满足特定的__相似性准则__(同时满足某种条件，比如在某个集合内或者相等)
  + 令$V$是用于定义连通性的灰度值集合,例如$V={x\mid0\lt x \lt 125}$
    + __4连通__：对于灰度值在$V$集合中的像素$p$和$q$,如果$p$在$q$的__4邻域__($N4(p)$中，那么称像素$p$和$q$是4连通的.
    + __8连通__：对于灰度值在$V$集合中的像素$p$和$q$,如果$p$在$q$的__8邻域__($N8(p)$中，那么称像素$p$和$q$是8连通的.
    + __m连通(混合连通)__:对于灰度值在$V$集合中的像素$p$和$q$,
      + $q$在$p$的4邻域中，或者
      + $q$在$p$的$D$邻域中，并且$p$的4邻域和$q$的4邻域的交集是空的（即没有灰度值在$V$集合中的像素点）
      + 那么称这两个像素是$m$连通的，即4连通和D连通的混合连通.
      + ???? 什么是D连通
+ 问题描述:已知某一8连通边界和边界内部的某个点，要求从该店开始填充整个边界包围的区域，这一过程被称为“种子填充”，填充的开始点被称为“种子”.