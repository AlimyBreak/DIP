

# 4.1.1 图像增强概述

+ 图像增强的概念和目的
  +  采用一系列技术__改善图像的视觉效果__,或将__图像转换__成一种更__适合__于人或机器进行__分析__和__处理__的形式.
  +  目的:
     +   改善图像的视觉效果;
     +   突出图像中感兴趣的信息，抑制不需要的信息，来提高图像的使用价值;
     +   转换为更适合人或机器分析处理的形式;
     +   需要注意的一点：增强后的图像不一定保真。
  
+ 图像增强的主要方法
  + 按照图像的作用域区分
    + __空间域增强__:直接对图像各像素进行处理
    + __频率域增强__:对图像经傅立叶变换后的频谱成分进行处理,然后逆傅立叶变换得到需要的图像

+ 图像增强的应用
    + 十分广泛


+ 图像增强的方法
  + __对比度增强__:扩大图像中感兴趣特征的目标
    + __灰度变换法__:通过调整__图像的灰度动态范围或调整图像的对比度__对图像进行增强.
      + 对比度:就是明暗的对比程度
      + __线性变换__:曝光不足或过曝，灰度会局限在很小的范围内，此时可以对曝光不足的图像用线性拉伸，可以有效的改善图像的视觉效果。
        + 分段线性变换:突出感兴趣的目标所在的灰度区间(被拉伸)，抑制不感兴趣的灰度区间(被压缩)
      + __对数变换__
      + __指数变换__
    + __直方图调整法__:
      + __直方图均衡化__
    + __空间域增强__:
    + __频率域增强__:



# 4.1.2 直方图均衡化

+ 灰度直方图的概念
  
+ 用来反应数字图像中每一个__灰度级__与这个灰度级__出现频率__之间的关系，可以描述图像的概貌。
  
+ 直方图修正法
  + 直方图均衡化(主要讲解))
  + 直方图规定化

+ 直方图均衡化
  + 将原图像通过某种变换，得到一副__灰度直方图均匀分布__的新图像.
  + 连续变化图像的均衡化问题:
  若$r$表示归一化的原图像灰度,$s$表示经过修正后的图像灰度.即
  $$
  T(r)=s,0\le r,s \le 1
  $$
  $T(r)$称为变换函数,需要满足以下条件:
  + 条件$1$:在$r\in [0,1]$内,$T(r)$单调递增;
  + 条件$2$:在$r\in [0,1]$内,有$0\le T(r)\le 1$
  条件$1$保证灰度级从黑到白的次序不变;
  条件$2$保证映射后的像素灰度在允许的范围内.
  则反变换关系为
  $$
  r = T^{-1}(s)
  $$
  显然$T^{-1}(s)$对$s$也要满足上述条件$1$和条件$2$.
  从概率论理论我们可以知道，如果已知随机变量$r$的概率密度为$p_r(r)$而随机变量$s$是$r$的函数,则$s$的概率密度$p_s(s)$可以由$p_r(r)$求出
  假定随机变量$s$的分布函数用$F_s(s)$表示,根据分布函数的定义,有(换个积分变量比较好,这里怕搞混直接用了)
  $$
  F_s(s)=\int_{-\infty}^{s}p_s(s)ds = \int_{-\infty}^{r}p_r(r)dr
  $$
  利用__密度函数是分布函数的导数的关系__,等式两边对$s$求导,可以得到:
  $$
  \tag{一}
  P_s(s)=\frac{d}{ds}\left[\int_{-\infty}^{r}p_r(r)dr\right] = p_r\frac{dr}{ds} = p_r\frac{d}{ds}\left[T^{-1}(s)\right]
  $$
  公式$(一)$是__直方图修正级数的基础__:可以通过变换函数$T(r)$控制原图像原图像灰度级的概率密度函数$p_r$，得到输出图像的概率密度函数$p_s$，因此可以改善原图像的灰度层次。
  + 从__人眼视觉特性__来考虑,一副图像的直方图如果是__均匀分布__的，即$P_s(s)=k$(归一化后$k=1$),__该图像色调给人的感觉比较协调__。所以将原图像的直方图均衡化后，可以满足人眼的视觉要求.

  + 如何求出$T(r)$
    +  根据归一化假设
    $$
    P_s(s) = 1
    $$
    由公式$(一)$得到(左边等于1):
    $$
    ds = p_r(r)dr
    $$
    两边同时求积分可以知道
    $$
    \tag{二}
    s = T(r) = \int_{0}^{r}p_r(r)dr
    $$
    所以,变换函数就是$r$的累计直方图函数。

    + 将公式$(二)$推广到离散的数字图像,用频率代替概率,则变换函数$T(r_k)$的离散形式可表示为:
    $$
    s_k = T(r_k) = \sum_{j=0}^{k}p_r(r_j) = \sum_{j=0}^{k}\frac{n_j}{n}
    $$
    这表明,均衡化后各像素的灰度值$s_k$可直接由原图像的直方图计算出来.

  + 习题
  如有一幅总像素为$n=64\times64=4096$的图像，灰度级数为$8$,各灰度级分布列于表中。对其进行均衡化，计算过程如下：

  | $r_{k}$(归一化后的r取值) | $n_k$ | $p_r(r_k)=\frac{n_k}{n}$ |
  | :----------------------: | :---: | :----------------------: |
  |         $r_0=0$          |  790  | $\frac{790}{4096}=0.19$  |
  |    $r_1=\frac{1}{7}$     | 1023  | $\frac{1023}{4096}=0.25$ |
  |    $r_2=\frac{2}{7}$     |  850  | $\frac{850}{4096}=0.21$  |
  |    $r_3=\frac{3}{7}$     |  659  | $\frac{659}{4096}=0.16$  |
  |    $r_4=\frac{4}{7}$     |  329  | $\frac{329}{4096}=0.08$  |
  |    $r_5=\frac{5}{7}$     |  245  | $\frac{245}{4096}=0.06$  |
  |    $r_6=\frac{6}{7}$     |  122  | $\frac{122}{4096}=0.03$  |
  |         $r_7=1$          |  81   |  $\frac{81}{4096}=0.02$  |

  | $r$  |  $r_k$(归一化后)  |      $s_k$       |    反归一化     |               $p_s(k)$                |
  | :--: | :---------------: | :--------------: | :-------------: | :-----------------------------------: |
  |  0   |      $r_0=0$      |      $0.19$      | $1.33\approx 1$ |    $p_s(1)=\frac{790}{4096}=0.19$     |
  |  1   | $r_1=\frac{1}{7}$ | $0.19+0.25=0.44$ | $3.08\approx3$  |    $p_s(3)=\frac{1023}{4096}=0.25$    |
  |  2   | $r_2=\frac{2}{7}$ | $0.44+0.21=0.65$ | $4.55\approx5$  |    $p_s(5)=\frac{850}{4096}=0.21$     |
  |  3   | $r_3=\frac{3}{7}$ | $0.65+0.16=0.81$ | $5.67\approx6$  |  $p_s(6)=\frac{659+329}{4096}=0.24$   |
  |  4   | $r_4=\frac{4}{7}$ | $0.81+0.08=0.89$ | $6.23\approx6$  |                   -                   |
  |  5   | $r_5=\frac{5}{7}$ | $0.89+0.06=0.95$ | $6.65\approx7$  | $p_s(7)=\frac{245+122+81}{4096}=0.11$ |
  |  6   | $r_6=\frac{6}{7}$ | $0.95+0.03=0.98$ | $6.86\approx7$  |                   -                   |
  |  7   |      $r_7=1$      | $0.98+0.02=1.00$ |       $7$       |                   -                   |

  变换后只有5个等级了，分别为$1,3,5,6,7$.

  + 当原始图像的直方图不同而图像结构相同时,直方图均衡化所得到的结果在视觉上几乎是完全一致的.
  + 从灰度直方图的意义上说,如果一幅图像的直方图非零范围占有所有可能的灰度级并在在这些灰度级上均匀分布,那么这幅图像的对比度较高,而且灰度色调较为丰富,从而容于判读.







# 4.1.2 直方图规定化(精通Matlab数字图像处理与识别 张铮 Page63)
+ __直方图均衡化__可以自动确定灰度变换函数,从而获得均有均匀直方图的输出图像,他主要用于__增强动态范围偏小的图像对比度__,丰富图像的灰度级,这种方法的有点事操作简单,且结果可以预知,当图像需要__自动增强__时是一种不错的选择.

+ 有时,我们希望对变换过程进行控制:如能够__人为地修正直方图的形状__,或者说是具有__指定直方图__的输出图像.这样就可以有选择地增强某个灰度范围内的对比度或使图像灰度值满足某种特定的分布.

+ 这种用于产生具有特定直方图的图像的方法叫做:__直方图规定化__,或__直方图匹配__.

+ 理论基础:在运用均衡化原理的基础上,通过建立__原始图像__和__期望图像__(待匹配直方图的图像)之间的关系,使原始图像的直方图匹配特定的形状,从而弥补直方图不具备交互作用的特性.
  + 先对原始的图像进行均衡化
  $$
  \tag{4-7}
  s=f(r)=\int_{0}^{r}p_{r}(\mu )d\mu
  $$
  + 同时对待匹配直方图的图像进行均衡化处理
  $$
  \tag{4-8}
  v = g(z) = \int_{0}^{z}p_z(\lambda )d\lambda
  $$
  + 令$s=v$,可以得到
  
  $$
  \tag{4-9}
  v = g^{-1}(s) = g^{-1}(f(r))
  $$
  
  + 根据$\tag{4-7}$我们可以得到$f(r)$,根据$\tag{4-8}$我们可以得到$g(z)$,并且得到反函数$g^{-1}(z)$,对__原始输入图像??__应用$\tag{4-9}$公式进行变换,这样就执行了均衡化的逆处理.
  
+ 直方图规定化本质一种拟合过程,因此变换得到的直方图与标准目标图像的直方图并不会完全一致,然而即使只是相似的拟合,仍然使得规定化后的图像在亮度与对比度上具有类似标准图像的特性，正是直方图规定化的目的.

+ [习题](https://www.jianshu.com/p/a99c3c5b54b4)
  + 考虑一个$64\times 64$的假设图像,其直方图概率分布如下表第三列,希望直方图变换为下表第二列中规定的值.
  
    |  $Z_q$  | 规定的$p_z(Z_q)$ | 实际的$p_z(Z_k)$ |
    | :-----: | :--------------: | :--------------: |
    | $z_0=0$ |      $0.00$      |      $0.00$      |
    | $z_1=1$ |      $0.00$      |      $0.00$      |
    | $z_2=2$ |      $0.00$      |      $0.00$      |
    | $z_3=3$ |      $0.15$      |      $0.19$      |
    | $z_4=4$ |      $0.20$      |      $0.25$      |
    | $z_5=5$ |      $0.30$      |      $0.21$      |
    | $z_6=6$ |      $0.20$      |      $0.24$      |
    | $z_7=7$ |      $0.15$      |      $0.11$      |
  
  + 第一步对原始图像进行均衡化:
    $$
    \begin{eqnarray}
    f(r=z_0)&=&\frac{0}{1}*7=0\\
    f(r=z_1)&=&\frac{0+0}{1}*7=0\\
    f(r=z_2)&=&\frac{0+0+0}{1}*7=0\\
    f(r=z_3)&=&\frac{0+0+0+0.19}{1}*7=1.33\approx 1 \\
    f(r=z_4)&=&\frac{0+0+0+0.19+0.25}{1}*7=3.08\approx 3 \\
    f(r=z_5)&=&\frac{0+0+0+0.19+0.25+0.21}{1}*7=4.55\approx 5 \\
    f(r=z_6)&=&\frac{0+0+0+0.19+0.25+0.21+0.24}{1}*7=6.23\approx 6 \\
    f(r=z_7)&=&7
    \end{eqnarray}
    $$
    
  + 可以得到$f(r)$
  
    | $f(r)$  | $p_r(r_k)$ |
    | :-----: | :--------: |
    | $r_0=0$ |   $0.00$   |
    | $r_1=1$ |   $0.19$   |
    | $r_2=3$ |   $0.25$   |
    | $r_3=5$ |   $0.21$   |
    | $r_4=6$ |   $0.24$   |
    | $r_5=7$ |   $0.11$   |
  
    
  
  + 第二步对目标直方图进行归一化
    $$
    \begin{eqnarray}
    g(z=z_0) &=&\frac{0}{1}*7 = 0\\
    g(z=z_1) &=&\frac{0+0}{1}*7 = 0\\
    g(z=z_2) &=&\frac{0+0+0}{1}*7 = 0\\ 
    g(z=z_3) &=&\frac{0+0+0+0.15}{1}*7 = 1.05 \approx 1  \\    
    g(z=z_4) &=&\frac{0+0+0+0.15+0.20}{1}*7 = 2.45 \approx 2  \\
    g(z=z_5) &=&\frac{0+0+0+0.15+0.20+0.30}{1}*7 = 4.55 \approx 5  \\  
    g(z=z_6) &=&\frac{0+0+0+0.15+0.20+0.30+0.20}{1}*7 = 5.95 \approx 6  \\  
    g(z=z_7) &=&7
    \end{eqnarray}
    $$
    
  + 对$g(z)$取反函数可以得到
    $$
    \begin{eqnarray}
    g^{-1}(z=0) &=&0,1,2  \\
    g^{-1}(z=1) &=&3      \\    
    g^{-1}(z=2) &=&4      \\
    g^{-1}(z=5) &=&5      \\
    g^{-1}(z=6) &=&6      \\
    g^{-1}(z=7) &=&7
    \end{eqnarray}
  $$
  + 根据$v=g^{-1}(f(r))$,可以得到直方图规定化后的变换关系.
  
  | $p_r(r_k)$ | $f(r)$ |       $v_c$       | $v$  |
  | :--------: | :----: | :---------------: | :--: |
  |   $0.00$   |  $0$   | $g^{-1}(0)=0,1,2$ | $0$  |
  |   $0.19$   |  $1$   |   $g^{-1}(1)=3$   | $3$  |
  |   $0.25$   |  $3$   |  $g^{-1}(3)=???$  | $4$  |
  |   $0.21$   |  $5$   |   $g^{-1}(5)=5$   | $5$  |
  |   $0.24$   |  $6$   |   $g^{-1}(6)=6$   | $6$  |
|   $0.11$   |  $7$   |   $g^{-1}(7)=7$   | $7$  |
  + 对比一下规定化后的图像直方图分布和模板直方图.
  
    | $Z_k$ | $p_z(z_k)$ | $p_v(v_k)$ | $$p_r(r_k)$$ | $p_z(Z_q)$ |
    | :---: | :--------: | :--------: | :----------: | :--------: |
    |  $0$  |   $0.00$   |   $0.00$   |    $0.00$    |   $0.00$   |
    |  $1$  |   $0.00$   |   $0.00$   |    $0.19$    |   $0.00$   |
    |  $2$  |   $0.00$   |   $0.00$   |    $0.00$    |   $0.00$   |
    |  $3$  |   $0.19$   |   $0.19$   |    $0.25$    |   $0.15$   |
    |  $4$  |   $0.25$   |   $0.25$   |    $0.00$    |   $0.20$   |
    |  $5$  |   $0.21$   |   $0.21$   |    $0.21$    |   $0.30$   |
    |  $6$  |   $0.24$   |   $0.24$   |    $0.24$    |   $0.20$   |
    |  $7$  |   $0.11$   |   $0.11$   |    $0.11$    |   $0.15$   |
  
    
  
  
  

